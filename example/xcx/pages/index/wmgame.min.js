var wmGame=wmGame||{};(function(e){e.init=function(e,t,n){var i=new a(e,n,function(e){t(i,e)})};function a(t,e,n){var s=e;var l=this;var d=0;var _=60;var x;var w;var T;this.create=function(e){if(!Array.isArray(e)){console.log("create传入数据必须是数组");return false}var s=new P.contain;s.mcs={};function d(e,t){for(var n=t.length-1;n>=0;n--){var i=t[n];if(Array.isArray(i)){var a=new P.contain;e.addChild(a);d(a,i)}else if(c(i)){if(!o(i))return false;else{if(i.t=="s"){var r=l.createShape(i.v)}else if(i.t=="i"){r=l.creatImg(i.v)}else if(i.t=="t"){r=l.createTxt(i.v)}if(i.t!="c"){if(i.s!=undefined){var f=i.s;if(f.x!=undefined)r.x=f.x;if(f.y!=undefined)r.y=f.y;if(f.a!=undefined)r.alpha=f.a;if(f.sx!=undefined)r.scaleX=f.sx;if(f.sy!=undefined)r.scaleY=f.sy;if(f.r!=undefined)r.rotate=f.r}e.addChild(r);if(i.z!=undefined){s.mcs[i.z]=r}}else{if(i.s!=undefined){var f=i.s;if(f.x!=undefined)e.x=f.x;if(f.y!=undefined)e.y=f.y;if(f.a!=undefined)e.alpha=f.a;if(f.sx!=undefined)e.scaleX=f.sx;if(f.sy!=undefined)e.scaleY=f.sy;if(f.r!=undefined)e.rotate=f.r}s.mcs[i.z]=e}}}else{return false}}}d(s,e);function o(e){if(e&&e.t!="s"&&e.t!="i"&&e.t!="t"&&e.t!="c"){console.log(e,"对象的t是无效变量");return false}if(e.s==undefined||e.s==null){e.s={}}return true}return s};this.contain=function(){return new P.contain};this.creatImg=function(e){if(!c(e)){console.log(e,"图片创建参数必须是对象");return}if(typeof e.s==="string"){var t=P.canvas.createImage();t.src=e.s}else{t=e.s}return new P.createImage(t,e.x,e.y)};this.createShape=function(e){if(!c(e)){console.log(e,"图形创建参数必须是对象");return}e.d.width=e.d.w;e.d.height=e.d.h;e.d.color=e.d.c;return new P.createShape(e.t,e.d)};this.createTxt=function(e){if(!c(e)){console.log(e,"文本创建参数必须是对象");return}if(e.t==undefined)e.t=" ";return new P.createTxt(e.t,e.s+" "+e.ty,e.c,"left",e.x,e.y)};this.update=function(e){if(e==undefined){P.openRepick(undefined,false)}else if(e=="loop"){P.openRepick()}else if(e=="stop"){P.opening=false;P.removeTime()}};this.addAct=function(e,t,n,...i){var a;var r;var f;for(var s=0;s<i.length;s++){if(a==undefined&&typeof i[s]=="function"&&s==0){a=i[s]}else if(f==undefined&&typeof i[s]=="boolean"&&s<=1){f=i[s]}else if(f==undefined&&typeof i[s]=="boolean"&&s<=2&&s>0){r=i[s]}}d++;P.tweenCreate("m"+d,e,t,n,r,f,a);return"m"+d};this.removeAct=function(e){P.tweenRemove(e)};this.setFps=function(e){if(e!=_){_=e;if(P._time!=undefined){P.removeTime();var t=P.repickFun;P.openRepick(undefined,P.opening,P.noClear)}}else{_=e}};this.on=function(e,t){if(e=="tick"){if(w==undefined)w=[];w.push(t)}else if(e=="tickDown"){if(T==undefined)T=[];T.push(t)}};this.off=function(e,t){if(e=="tick"){if(t==undefined)w=undefined;else{if(w!=undefined){for(var n=0;n<w.length;n++){if(w[n]==t){w.splice(n,1);return}}}}}else if(e=="tickDown"){if(t==undefined)T=undefined;else{if(T!=undefined){for(var n=0;n<T.length;n++){if(T[n]==t){T.splice(n,1);return}}}}}};function c(e){return e!==null&&!Array.isArray(e)&&typeof e==="object"}function h(e,t,n,i,a){e._eventType=i;e._eventSX=a;var r={mc:e,type:t,fun:n};v.push(r)}function u(e,t){for(var n=0;n<v.length;n++){if(v[n].mc==e&&v[n].type==t){v.splice(n,1)}}}function b(e,t,n){var i=e.length,a=i,r=0;for(var f=0;f<i;f++){if(e.charCodeAt(f)>128){if(r+2<=t){r+=2}else{a=f;break}}else{if(r+1<=t){r+=1}else{a=f;break}}}if(n==-1)return e.substr(0,a)+"...";else if(i==a)return e;else if(n==1)return e.substr(0,a);else if(n==0)return e.substr(0,a)+"..."}function o(e,t,n,i){var a=e.length;var r=0;var f=0;var s="";for(var d=0;d<a;d++){if(i!=undefined)t.font=i;var o=t.measureText(e[d]).width;r+=o;if(r>=n){if(d!=a-1)s=s+e.slice(f,d+1)+"\n";else s=s+e.slice(f,d+1);f=d+1;r=0}}s=s+e.slice(f);return s}function i(){const e=wx.createSelectorQuery();e.select("#"+t).fields({node:true,size:true}).exec(e=>{let t=e[0].node;t.width=s.width;t.height=s.height;t.realWidth=e[0].width;t.realHeight=e[0].height;P.inite(t);l.stage=P.stage;n(P.canvas)})}var v=[];var I=[];var P={inite:function(e,t,n){var i,a;a=e;if(a.getContext==undefined)i=a;else{i=a.getContext("2d")}i.scale(1,1);P.ctx=i;P.canvas=a;P.stage=new P.contain;if(P.fps==undefined)P.fps=60;if(a.requestAnimationFrame==undefined){a.timesp=-1;a.requestAnimationFrame=function(e){a.timesp=setTimeout(function(){e();a.requestAnimationFrame(e)},1e3/60)}}s.that[s.touchstart]=r;s.that[s.touchmove]=r;s.that[s.touchend]=r;s.that[s.touchcancel]=r;function r(e){P.events(e)}function f(e){}P.remove=function(){s.that[s.touchstart]=f}},createImage:function(e,t,n,i,a,r,f){var s=this;s.type="img";s.img=e;s.x=t!=undefined?t:0;s.y=n!=undefined?n:0;s.regX=i!=undefined?i:0;s.regY=a!=undefined?a:0;s.scaleX=r!=undefined?r:1;s.scaleY=f!=undefined?f:1;s.rotate=0;s.alpha=1;s.on=function(e,t,n,i){h(s,e,t,n,i)};s.off=function(e,t){u(s,e,t)}},createImage2:function(e,t,n,i,a){if(a==undefined){a=i/e.width;i=a}else if(i==undefined){a=a/e.height;i=a}else{i=i/e.width;a=a/e.height}let r=new P.createImage(e,t,n,e.width/2,e.height/2,i,a);return r},createTxt:function(e,t,n,i,a,r,f,s){var d=this;d.type="txt";d.text=e!=undefined?e:"".toString();d.size=t!=undefined?t:"20px Microsoft Yahei";d.color=n!=undefined?n:"#ffffff";d.align=i!=undefined?i:"center";d.x=a!=undefined?a:0;d.y=r!=undefined?r:0;d.maxWith=f;d.maxHeight=s;d.alpha=1;var o=P.ctx;o.font=d.size;d.text=d.text.toString();var l=d.text.split("\n");if(l.length==1)d.width=o.measureText(d.text).width;else{for(var c=0;c<l.length;c++){if(c==0)d.width=o.measureText(l[c]).width;else if(d.width<o.measureText(l[c]).width)d.width=o.measureText(l[c]).width}}d.on=function(e,t,n,i){h(d,e,t,n,i)};d.off=function(e,t){u(d,e,t)}},createTxt2:function(e,t,n,i,a,r,f){return new P.createTxt(e,t.size,t.color,n,i,a,r,f)},createShape:function(e,t){var a=this;a.type="shape";if(t.scx!=undefined)a.scx=t.scx;else a.scx=1;if(t.scy!=undefined)a.scy=t.scy;else a.scy=1;if(e==1){a.width=t.width;a.height=t.height}else if(e==2){a.r=t.r}else if(e==3){a.width=t.width;a.height=t.height;a.r=t.r}else if(e==4){a.points=t.points}else if(e==-1){a.drawOther=t.drawOther}a.x=t.x||0;a.y=t.y||0;a.color=t.color;a.typeSp=e;a.alpha=1;a.on=function(e,t,n,i){h(a,e,t,n,i)};a.off=function(e,t){u(a,e,t)}},contain:function(){var a=this;a.type="cons";a._childs=[];a.x=0;a.y=0;a.rotate=0;a.alpha=1;a.addChild=function(e){a._childs.push(e);e._daddy=a};a.addChild2=function(e){a._childs.unshift(e);e._daddy=a};a.removeChild=function(e){var t=a._childs;for(var n=0;n<t.length;n++){if(t[n]==e){e._daddy=undefined;t.splice(n,1);return}}};a.on=function(e,t,n,i){h(a,e,t,n,i)};a.off=function(e,t){u(a,e,t)}},openRepick:function(e,r){if(P._time!=undefined)return;var f=P.canvas;var d=P.ctx;if(e==undefined)P.opening=true;else P.opening=e;P.noClear=r;var s=1e3/_;var o=Date.now();var l;var c=1;h();P._showPage=u;P.onFrameHandle=function(){if(P._time==undefined)P._time=f.requestAnimationFrame(h)};function h(){l=Date.now();if(l-o<s*c){if(P.opening)P._time=f.requestAnimationFrame(h);return}x=(l-o)/s/c*_;c++;if(c>=_){c=1;o=l}if(P.opening)P._time=f.requestAnimationFrame(h);else P._time=undefined;if(w!=undefined){for(var e=0;e<w.length;e++){w[e]()}}if(I!=undefined&&I.length!=0){for(var t=0;t<I.length;t++){var n=I[t];var i=false;var a=n.sm.i++;for(var e in n.obj){n.mc[e]=n.sm[e][a];if(a==n.sm[e].length-1){i=true}}if(i){if(n.loop==false){I.splice(t,1);if(n.callBack!=undefined)n.callBack();t--}else{if(n.loop<0)n.loop++;n.sm.i=0}}}}if(r==undefined)d.clearRect(0,0,f.width,f.height);u(P.stage);if(T!=undefined){for(var e=0;e<T.length;e++){T[e]()}}}function u(e){d.save();m(e);d.translate(e.x,e.y);if(e.rotate==undefined)e.rotate=0;var t=e.rotate*Math.PI/180;d.globalAlpha*=e.alpha;d.rotate(t);if(e.scaleX!=undefined||e.scaleY!=undefined){if(e.scaleX==undefined)var n=1,i=e.scaleY;else if(e.scaleY==undefined)var i=1,n=e.scaleX;else n=e.scaleX,i=e.scaleY;d.scale(n,i)}if(e.transform!=undefined){var n=e.transform;d.transform(n[0],n[1],n[2],n[3],n[4],n[5])}for(var a=0;a<e._childs.length;a++){if(e._childs[a].type=="img"){v(e._childs[a])}else if(e._childs[a].type=="cons"){u(e._childs[a])}else if(e._childs[a].type=="txt"){p(e._childs[a])}else if(e._childs[a].type=="shape"){g(e._childs[a])}}y(e);d.restore();if(d==P.canvas){d.draw()}}function v(e){d.save();m(e);var t=e.img.width;var n=e.img.height;var i=e.regX;var a=e.regY;if(e.rotate==undefined)e.rotate=0;var r=e.rotate*Math.PI/180;d.globalAlpha*=e.alpha;d.scale(e.scaleX,e.scaleY);d.translate(e.x,e.y);d.rotate(r);if(e.transform!=undefined){var f=e.transform;d.transform(f[0],f[1],f[2],f[3],f[4],f[5])}d.imageSmoothingEnabled=true;d.drawImage(e.img,0,0,e.img.width,e.img.height,-i,-a,t,n);y(e);d.restore()}function p(e){e.text=e.text.toString();d.save();m(e);d.textAlign=e.align;d.font=e.size;d.fillStyle=e.color;d.globalAlpha*=e.alpha;d.translate(e.x,e.y);d.scale(e.scaleX,e.scaleY);if(e.rotate==undefined)e.rotate=0;var t=e.rotate*Math.PI/180;d.rotate(t);var n=e.text;var i=n.split("\n");if(e.lineHeight==undefined)e.lineHeight=0;for(var a=0;a<i.length;a++){var r=i[a];var f=false;if(e.maxWith!=undefined){if(e.maxHeight!=undefined&&a==e.maxHeight-1){if(i.length>e.maxHeight){r=b(r,e.maxWith-3,-1)}else{r=b(r,e.maxWith-3,0)}f=true}else{r=b(r,e.maxWith,1);var s=i[a].replace(r,"");if(s!="")i.splice(a+1,0,s)}d.fillText(r,0,e.lineHeight*a,e.maxWidth)}else{if(a==0)e.width=d.measureText(r).width;else if(e.width<d.measureText(r).width)e.width=d.measureText(r).width;d.fillText(r,0,e.lineHeight*a)}if(f)break}d.restore();y(e)}function g(e){d.save();m(e);d.fillStyle=e.color;d.strokeStyle=e.color;d.globalAlpha*=e.alpha;d.translate(e.x,e.y);d.scale(e.scaleX,e.scaleY);if(e.rotate==undefined)e.rotate=0;var t=e.rotate*Math.PI/180;d.rotate(t);d.beginPath();if(e.transform!=undefined){var n=e.transform;d.transform(n[0],n[1],n[2],n[3],n[4],n[5])}if(e.typeSp==1){d.fillRect(0,0,e.width,e.height);y(e)}else if(e.typeSp==2){d.scale(e.scx,e.scy);d.moveTo(e.r,e.r);d.arc(0,0,e.r,0,2*Math.PI);y(e);d.fill()}else if(e.typeSp==3){d.scale(e.scx,e.scy);i(d,e);y(e);d.fill()}else if(e.typeSp==4){d.scale(e.scx,e.scy);a(d,e);y(e);d.fill()}else if(e.typeSp==-1){d.scale(e.scx,e.scy);e.drawOther();y(e)}d.restore()}function m(e){if(e.mask!=undefined){var t=e.mask;d.beginPath();if(t.typeSp==1){d.rect(t.x,t.y,t.width,t.height)}else if(t.typeSp==2){d.scale(t.scx,t.scy);d.moveTo(t.x+t.r,t.y);d.arc(t.x,t.y,t.r,0,2*Math.PI);d.scale(1/t.scx,1/t.scy)}else if(t.typeSp==3){i(d,t)}else if(e.typeSp==4){a(d,e)}else if(e.typeSp==-1){e.drawOther()}d.clip()}}function y(e){if(e._eventType==undefined||e._event==undefined)return;else{var n=e._eventSX;d.save();if(e._eventType==1){d.beginPath();d.rect(n.x,n.y,n.width,n.height)}else if(e._eventType==2){if(n.scx==undefined)n.scx=1;if(n.scy==undefined)n.scy=1;d.beginPath();d.scale(n.scx,n.scy);d.moveTo(n.x+n.r,n.y);d.arc(n.x,n.y,n.r,0,2*Math.PI)}d.closePath();var i=d.isPointInPath(e._event.x,e._event.y);let t=[Number(e.x),Number(e.y)];a(e);function a(e){if(e._daddy!=undefined){t[0]+=Number(e._daddy.x);t[1]+=Number(e._daddy.y);a(e._daddy)}}if(i==undefined){if(e._eventType==1){if(e._event.x>=n.x+t[0]&&e._event.x<=n.x+t[0]+n.width&&e._event.y>=n.y+t[1]&&e._event.y<=n.y+t[1]+n.height){e._event.fun({x:e._event.x,y:e._event.y})}}else if(e._eventType==2){var r=[t[0]+n.x,t[1]+n.y];var f=Math.sqrt((r[0]-e._event.x)*(r[0]-e._event.x)+(r[1]-e._event.y)*(r[1]-e._event.y));if(f<=n.r){e._event.fun({x:e._event.x,y:e._event.y})}}}else if(i){e._event.fun({x:e._event.x,y:e._event.y})}d.restore();e._event=undefined}}function i(e,t){e.beginPath();var n=t.x;var i=t.y;e.moveTo(n+t.width-t.r,i+t.height-t.r);e.arc(n+t.width-t.r,i+t.height-t.r,t.r,0,Math.PI/2);e.lineTo(n+t.r,i+t.height);e.arc(n+t.r,i+t.height-t.r,t.r,Math.PI/2,Math.PI);e.lineTo(n,i+t.r);e.arc(n+t.r,i+t.r,t.r,Math.PI,Math.PI*3/2);e.lineTo(n+t.width-t.r,i);e.arc(n+t.width-t.r,i+t.r,t.r,Math.PI*3/2,Math.PI*2);e.lineTo(n+t.width,i+t.height-t.r);e.closePath();e.stroke()}function a(e,t){e.beginPath();var n=t.x;var i=t.y;for(var a=0;a<t.points.length;a++){if(a==0)e.moveTo(n+t.points[a].x,i+t.points[a].y);else e.lineTo(n+t.points[a].x,i+t.points[a].y)}a=0;e.lineTo(n+t.points[a].x,i+t.points[a].y);e.closePath();e.stroke()}},removeTime:function(){if(P._time!=undefined){P.canvas.cancelAnimationFrame(P._time);P._time=undefined}},removeRepickFun:function(e){for(var t=0;t<P.repickFun.length;t++){if(e==P.repickFun[t]){P.repickFun.splice(t,1)}}},events:function(e,t){if(e.changedTouches.length==0&&e.touches.length==0)return;else if(e.changedTouches.length==0&&e.touches.length!=0)e.changedTouches=e.touches;let n={x:e.changedTouches[0].x,y:e.changedTouches[0].y};if(n.x==undefined&&e.changedTouches[0].pageX!=undefined){n.x=e.changedTouches[0].pageX;n.y=e.changedTouches[0].pageY}else if(n.x==undefined&&e.changedTouches[0].clientX!=undefined){n.x=e.changedTouches[0].clientX;n.y=e.changedTouches[0].clientY}let i=P.canvas.width/P.canvas.realWidth;let a=P.canvas.height/P.canvas.realHeight;var r=n.x*i;var f=n.y*a;for(var s=0;s<v.length;s++){if(v[s].type==e.type){v[s].mc._event={x:r,y:f,fun:v[s].fun}}}},tweenCreate:function(e,t,n,i,a,r,f){var s={};s.name=e;s.mc=t;s.obj=n;s.time=i;s.sm={};s.callBack=f;for(var d in n){var o=t[d];var l=n[d];var c=[];if(l.length!=undefined&&l.length!=0){var h=[];var u=[];var v=[];var p=0;for(var g=0;g<l.length;g++){if(g==0){h.push(l[g]-o);v.push(o)}else{h.push(l[g]-l[g-1]);v.push(l[g-1])}p+=Math.abs(h[g])}for(var g=0;g<h.length;g++){if(p==0){u.push(parseInt(i*_/(1e3*h.length)))}else{u.push(parseInt(Math.abs(h[g])*i*_/(1e3*p)))}for(var m=0;m<u[g];m++){if(p==0){c.push(o);continue}var y=(m+1)/u[g];if(a!=undefined&&a!=-1){x=a(y)*(l[g]-v[g])+v[g]}else{var x=y*(l[g]-v[g])+v[g]}c.push(x)}}}else{var w=parseInt(i*_/1e3);for(var m=0;m<w;m++){var y=(m+1)/w;if(a!=undefined&&a!=-1){x=a(y)*(l-o)+o}else{var x=y*(l-o)+o}c.push(x)}}s.sm[d]=c;s.sm.i=0}if(r==undefined||r==false)s.loop=false;else{if(r>1)s.loop=-r;else s.loop=r}I.push(s);return s.name},tweenRemove:function(e){for(var t=0;t<I.length;t++){if(I[t].name==e){I.splice(t,1);break}}},removeMc:function(){I=[];v=[];P.stage._childs=[];P.clearEnd=true;this.removeTime()}};P.getLineTxt=function(e,t,n,i){if(e==undefined||e=="")return"";e=e.toString();var a=e.split("\n");var r="";for(var f=0;f<a.length;f++){var s=a[f];s=o(s,t,n,i);if(f!=0)r+="\n"+s;else r+=s}return r};i()}})(wmGame);export default wmGame;