var wmGame=wmGame||{};(function(e){e.init=function(e,n,t){var i;var a=new r(e,t,function(e){i=e});n(a,i)};function r(e,n,t){var i=n;var d=this;var o=0;var T=60;var x;var w;var _;this.create=function(e){if(!Array.isArray(e)){console.log("create传入数据必须是数组");return false}var s=new I.contain;s.mcs={};function o(e,n){for(var t=n.length-1;t>=0;t--){var i=n[t];if(Array.isArray(i)){var a=new I.contain;e.addChild(a);o(a,i)}else if(l(i)){if(!c(i))return false;else{if(i.t=="s"){var r=d.createShape(i.v)}else if(i.t=="i"){r=d.creatImg(i.v)}else if(i.t=="t"){r=d.createTxt(i.v)}if(i.t!="c"){if(i.s!=undefined){var f=i.s;if(f.x!=undefined)r.x=f.x;if(f.y!=undefined)r.y=f.y;if(f.a!=undefined)r.alpha=f.a;if(f.sx!=undefined)r.scaleX=f.sx;if(f.sy!=undefined)r.scaleY=f.sy;if(f.r!=undefined)r.rotate=f.r}e.addChild(r);if(i.z!=undefined){s.mcs[i.z]=r}}else{if(i.s!=undefined){var f=i.s;if(f.x!=undefined)e.x=f.x;if(f.y!=undefined)e.y=f.y;if(f.a!=undefined)e.alpha=f.a;if(f.sx!=undefined)e.scaleX=f.sx;if(f.sy!=undefined)e.scaleY=f.sy;if(f.r!=undefined)e.rotate=f.r}s.mcs[i.z]=e}}}else{return false}}}o(s,e);function c(e){if(e&&e.t!="s"&&e.t!="i"&&e.t!="t"&&e.t!="c"){console.log(e,"对象的t是无效变量");return false}if(e.s==undefined||e.s==null){e.s={}}return true}return s};this.contain=function(){return new I.contain};this.creatImg=function(e){if(!l(e)){console.log(e,"图片创建参数必须是对象");return}if(typeof e.s==="string"){var n=new Image;n.src=e.s}else{n=e.s}return new I.createImage(n,e.x,e.y)};this.createShape=function(e){if(!l(e)){console.log(e,"图形创建参数必须是对象");return}e.d.width=e.d.w;e.d.height=e.d.h;e.d.color=e.d.c;return new I.createShape(e.t,e.d)};this.createTxt=function(e){if(!l(e)){console.log(e,"文本创建参数必须是对象");return}if(e.t==undefined)e.t=" ";return new I.createTxt(e.t,e.s+" "+e.ty,e.c,"left",e.x,e.y)};this.update=function(e){if(e==undefined){I.openRepick(undefined,false)}else if(e=="loop"){I.openRepick()}else if(e=="stop"){I.opening=false;I.removeTime()}};this.addAct=function(e,n,t,...i){var a;var r;var f;for(var s=0;s<i.length;s++){if(a==undefined&&typeof i[s]=="function"&&s==0){a=i[s]}else if(f==undefined&&typeof i[s]=="boolean"&&s<=1){f=i[s]}else if(f==undefined&&typeof i[s]=="boolean"&&s<=2&&s>0){r=i[s]}}o++;I.tweenCreate("m"+o,e,n,t,r,f,a);return"m"+o};this.removeAct=function(e){I.tweenRemove(e)};this.setFps=function(e){if(e!=T){T=e;if(I._time!=undefined){I.removeTime();var n=I.repickFun;I.openRepick(undefined,I.opening,I.noClear)}}else{T=e}};this.on=function(e,n){if(e=="tick"){if(w==undefined)w=[];w.push(n)}else if(e=="tickDown"){if(_==undefined)_=[];_.push(n)}};this.off=function(e,n){if(e=="tick"){if(n==undefined)w=undefined;else{if(w!=undefined){for(var t=0;t<w.length;t++){if(w[t]==n){w.splice(t,1);return}}}}}else if(e=="tickDown"){if(n==undefined)_=undefined;else{if(_!=undefined){for(var t=0;t<_.length;t++){if(_[t]==n){_.splice(t,1);return}}}}}};function l(e){return e!==null&&!Array.isArray(e)&&typeof e==="object"}function u(e,n,t,i,a){if(i==undefined)i=1;if(i==1&&a==undefined){a={x:e.x,y:e.y,width:e.width,height:e.height}}e._eventType=i;e._eventSX=a;var r={mc:e,type:n,fun:t};p.push(r);if(n=="touchstart"){r={mc:e,type:"mousedown",fun:t};p.push(r)}else if(n=="touchmove"){r={mc:e,type:"mousemove",fun:t};p.push(r)}else if(n=="touchend"){r={mc:e,type:"mouseup",fun:t};p.push(r);r={mc:e,type:"mouseout",fun:t};p.push(r)}}function h(e,n){for(var t=0;t<p.length;t++){if(p[t].mc==e&&p[t].type==n){p.splice(t,1)}}if(n=="touchstart"){h(e,"mousedown")}else if(n=="touchmove"){h(e,"mousemove")}else if(n=="touchend"){h(e,"mouseup");h(e,"mouseout")}}function k(e,n,t){var i=e.length,a=i,r=0;for(var f=0;f<i;f++){if(e.charCodeAt(f)>128){if(r+2<=n){r+=2}else{a=f;break}}else{if(r+1<=n){r+=1}else{a=f;break}}}if(t==-1)return e.substr(0,a)+"...";else if(i==a)return e;else if(t==1)return e.substr(0,a);else if(t==0)return e.substr(0,a)+"..."}function c(e,n,t,i){var a=e.length;var r=0;var f=0;var s="";for(var o=0;o<a;o++){if(i!=undefined)n.font=i;var c=n.measureText(e[o]).width;r+=c;if(r>=t){if(o!=a-1)s=s+e.slice(f,o+1)+"\n";else s=s+e.slice(f,o+1);f=o+1;r=0}}s=s+e.slice(f);return s}function a(){I.inite(e,i.enba,i.enbaFW);d.stage=I.stage;t(I.canvas)}var v=function(){var e={};e.isSupportTouch="ontouchend"in document?true:false;e.isEvent=e.isSupportTouch?"touchstart":"click";return e.isEvent};var p=[];var b=[];var I={inite:function(e,t,i){var n,a;a=document.getElementById(e);if(a==null){console.log("canvas的id不存着");return false}n=a.getContext("2d");n.scale(1,1);I.ctx=n;I.canvas=a;I.stage=new I.contain;var r=v();I.istouch=r;if(r=="touchstart"){I.canvas.addEventListener("touchstart",f);I.canvas.addEventListener("touchmove",f);I.canvas.addEventListener("touchend",f);I.canvas.addEventListener("touchcancel",f)}else if(r=="click"){I.canvas.addEventListener("mousemove",s);I.canvas.addEventListener("mousedown",s);I.canvas.addEventListener("mouseup",s);I.canvas.addEventListener("mouseout",s)}I.remove=function(){if(r=="touchstart"){I.canvas.removeEventListener("touchstart",f);I.canvas.removeEventListener("touchmove",f);I.canvas.removeEventListener("touchend",f);I.canvas.removeEventListener("touchcancel",f)}else if(r=="click"){I.canvas.removeEventListener("mousemove",s);I.canvas.removeEventListener("mousedown",s);I.canvas.removeEventListener("mouseup",s);I.canvas.removeEventListener("mouseout",s)}};function f(n){I.events(n,function(e){o(n,e)})}function s(n){n.changedTouches=[{}];n.changedTouches[0].pageX=n.pageX;n.changedTouches[0].pageY=n.pageY;I.events(n,function(e){o(n,e)})}function o(e,n){if(t){if(i==undefined||i!=undefined&&(n.x>=i.x&&n.x<=i.x+i.width&&n.y>=i.y&&n.y<=i.y+i.height)){e.stopPropagation();e.preventDefault()}}}},createImage:function(e,n,t,i,a,r,f){var s=this;s.type="img";s.img=e;s.x=n!=undefined?n:0;s.y=t!=undefined?t:0;s.regX=i!=undefined?i:0;s.regY=a!=undefined?a:0;s.scaleX=r!=undefined?r:1;s.scaleY=f!=undefined?f:1;s.rotate=0;s.alpha=1;s.on=function(e,n,t,i){u(s,e,n,t,i)};s.off=function(e,n){h(s,e,n)}},createImage2:function(e,n,t,i,a){if(a==undefined){a=i/e.width;i=a}else if(i==undefined){a=a/e.height;i=a}else{i=i/e.width;a=a/e.height}let r=new I.createImage(e,n,t,e.width/2,e.height/2,i,a);return r},createTxt:function(e,n,t,i,a,r,f,s){var o=this;o.type="txt";o.text=e!=undefined?e:"".toString();o.size=n!=undefined?n:"20px Microsoft Yahei";o.color=t!=undefined?t:"#ffffff";o.align=i!=undefined?i:"center";o.x=a!=undefined?a:0;o.y=r!=undefined?r:0;o.maxWith=f;o.maxHeight=s;o.alpha=1;var c=I.ctx;c.font=o.size;o.text=o.text.toString();var d=o.text.split("\n");if(d.length==1)o.width=c.measureText(o.text).width;else{for(var l=0;l<d.length;l++){if(l==0)o.width=c.measureText(d[l]).width;else if(o.width<c.measureText(d[l]).width)o.width=c.measureText(d[l]).width}}o.on=function(e,n,t,i){u(o,e,n,t,i)};o.off=function(e,n){h(o,e,n)}},createTxt2:function(e,n,t,i,a,r,f){return new I.createTxt(e,n.size,n.color,t,i,a,r,f)},createShape:function(e,n){var a=this;a.type="shape";if(n.scx!=undefined)a.scx=n.scx;else a.scx=1;if(n.scy!=undefined)a.scy=n.scy;else a.scy=1;if(e==1){a.width=n.width;a.height=n.height}else if(e==2){a.r=n.r}else if(e==3){a.width=n.width;a.height=n.height;a.r=n.r}else if(e==4){a.points=n.points}else if(e==-1){a.drawOther=n.drawOther}a.x=n.x||0;a.y=n.y||0;a.color=n.color;a.typeSp=e;a.alpha=1;a.on=function(e,n,t,i){u(a,e,n,t,i)};a.off=function(e,n){h(a,e,n)}},contain:function(){var a=this;a.type="cons";a._childs=[];a.x=0;a.y=0;a.rotate=0;a.alpha=1;a.addChild=function(e){a._childs.push(e);e._daddy=a};a.addChild2=function(e){a._childs.unshift(e);e._daddy=a};a.removeChild=function(e){var n=a._childs;for(var t=0;t<n.length;t++){if(n[t]==e){e._daddy=undefined;n.splice(t,1);return}}};a.on=function(e,n,t,i){u(a,e,n,t,i)};a.off=function(e,n){h(a,e,n)}},openRepick:function(e,r){if(I._time!=undefined)return;var f=I.canvas;var o=I.ctx;if(e==undefined)I.opening=true;else I.opening=e;I.noClear=r;var s=1e3/T;var c=Date.now();var d;var l=1;u();I._showPage=h;I.onFrameHandle=function(){if(I._time==undefined)I._time=window.requestAnimationFrame(u)};function u(){d=Date.now();if(d-c<s*l){if(I.opening)I._time=window.requestAnimationFrame(u);return}x=(d-c)/s/l*T;l++;if(l>=T){l=1;c=d}if(I.opening)I._time=window.requestAnimationFrame(u);else I._time=undefined;if(w!=undefined){for(var e=0;e<w.length;e++){w[e]()}}if(b!=undefined&&b.length!=0){for(var n=0;n<b.length;n++){var t=b[n];var i=false;var a=t.sm.i++;for(var e in t.obj){t.mc[e]=t.sm[e][a];if(a==t.sm[e].length-1){i=true}}if(i){if(t.loop==false){b.splice(n,1);if(t.callBack!=undefined)t.callBack();n--}else{if(t.loop<0)t.loop++;t.sm.i=0}}}}if(r==undefined)o.clearRect(0,0,f.width,f.height);h(I.stage);if(_!=undefined){for(var e=0;e<_.length;e++){_[e]()}}}function h(e){o.save();g(e);o.translate(e.x,e.y);if(e.rotate==undefined)e.rotate=0;var n=e.rotate*Math.PI/180;o.globalAlpha*=e.alpha;o.rotate(n);if(e.scaleX!=undefined||e.scaleY!=undefined){if(e.scaleX==undefined)var t=1,i=e.scaleY;else if(e.scaleY==undefined)var i=1,t=e.scaleX;else t=e.scaleX,i=e.scaleY;o.scale(t,i)}if(e.transform!=undefined){var t=e.transform;o.transform(t[0],t[1],t[2],t[3],t[4],t[5])}for(var a=0;a<e._childs.length;a++){if(e._childs[a].type=="img"){v(e._childs[a])}else if(e._childs[a].type=="cons"){h(e._childs[a])}else if(e._childs[a].type=="txt"){p(e._childs[a])}else if(e._childs[a].type=="shape"){m(e._childs[a])}}y(e);o.restore();if(o==I.canvas){o.draw()}}function v(e){o.save();g(e);var n=e.img.width;var t=e.img.height;var i=e.regX;var a=e.regY;if(e.rotate==undefined)e.rotate=0;var r=e.rotate*Math.PI/180;o.globalAlpha*=e.alpha;o.scale(e.scaleX,e.scaleY);o.translate(e.x,e.y);o.rotate(r);if(e.transform!=undefined){var f=e.transform;o.transform(f[0],f[1],f[2],f[3],f[4],f[5])}o.imageSmoothingEnabled=true;o.drawImage(e.img,0,0,e.img.width,e.img.height,-i,-a,n,t);y(e);o.restore()}function p(e){e.text=e.text.toString();o.save();g(e);o.textAlign=e.align;o.font=e.size;o.fillStyle=e.color;o.globalAlpha*=e.alpha;o.translate(e.x,e.y);o.scale(e.scaleX,e.scaleY);if(e.rotate==undefined)e.rotate=0;var n=e.rotate*Math.PI/180;o.rotate(n);var t=e.text;var i=t.split("\n");if(e.lineHeight==undefined)e.lineHeight=0;for(var a=0;a<i.length;a++){var r=i[a];var f=false;if(e.maxWith!=undefined){if(e.maxHeight!=undefined&&a==e.maxHeight-1){if(i.length>e.maxHeight){r=k(r,e.maxWith-3,-1)}else{r=k(r,e.maxWith-3,0)}f=true}else{r=k(r,e.maxWith,1);var s=i[a].replace(r,"");if(s!="")i.splice(a+1,0,s)}o.fillText(r,0,e.lineHeight*a,e.maxWidth)}else{if(a==0)e.width=o.measureText(r).width;else if(e.width<o.measureText(r).width)e.width=o.measureText(r).width;o.fillText(r,0,e.lineHeight*a)}if(f)break}o.restore();y(e)}function m(e){o.save();g(e);o.fillStyle=e.color;o.strokeStyle=e.color;o.globalAlpha*=e.alpha;o.translate(e.x,e.y);o.scale(e.scaleX,e.scaleY);if(e.rotate==undefined)e.rotate=0;var n=e.rotate*Math.PI/180;o.rotate(n);o.beginPath();if(e.transform!=undefined){var t=e.transform;o.transform(t[0],t[1],t[2],t[3],t[4],t[5])}if(e.typeSp==1){o.fillRect(0,0,e.width,e.height);y(e)}else if(e.typeSp==2){o.scale(e.scx,e.scy);o.moveTo(e.r,e.r);o.arc(0,0,e.r,0,2*Math.PI);y(e);o.fill()}else if(e.typeSp==3){o.scale(e.scx,e.scy);i(o,e);y(e);o.fill()}else if(e.typeSp==4){o.scale(e.scx,e.scy);a(o,e);y(e);o.fill()}else if(e.typeSp==-1){o.scale(e.scx,e.scy);e.drawOther();y(e)}o.restore()}function g(e){if(e.mask!=undefined){var n=e.mask;o.beginPath();if(n.typeSp==1){o.rect(n.x,n.y,n.width,n.height)}else if(n.typeSp==2){o.scale(n.scx,n.scy);o.moveTo(n.x+n.r,n.y);o.arc(n.x,n.y,n.r,0,2*Math.PI);o.scale(1/n.scx,1/n.scy)}else if(n.typeSp==3){i(o,n)}else if(e.typeSp==4){a(o,e)}else if(e.typeSp==-1){e.drawOther()}o.clip()}}function y(e){if(e._eventType==undefined||e._event==undefined)return;else{var n=e._eventSX;o.save();if(e._eventType==1){o.beginPath();o.rect(n.x,n.y,n.width,n.height)}else if(e._eventType==2){if(n.scx==undefined)n.scx=1;if(n.scy==undefined)n.scy=1;o.beginPath();o.scale(n.scx,n.scy);o.moveTo(n.x+n.r,n.y);o.arc(n.x,n.y,n.r,0,2*Math.PI)}o.closePath();if(o.isPointInPath(e._event.x,e._event.y)){e._event.fun({x:e._event.x,y:e._event.y})}o.restore();e._event=undefined}}function i(e,n){e.beginPath();var t=n.x;var i=n.y;e.moveTo(t+n.width-n.r,i+n.height-n.r);e.arc(t+n.width-n.r,i+n.height-n.r,n.r,0,Math.PI/2);e.lineTo(t+n.r,i+n.height);e.arc(t+n.r,i+n.height-n.r,n.r,Math.PI/2,Math.PI);e.lineTo(t,i+n.r);e.arc(t+n.r,i+n.r,n.r,Math.PI,Math.PI*3/2);e.lineTo(t+n.width-n.r,i);e.arc(t+n.width-n.r,i+n.r,n.r,Math.PI*3/2,Math.PI*2);e.lineTo(t+n.width,i+n.height-n.r);e.closePath();e.stroke()}function a(e,n){e.beginPath();var t=n.x;var i=n.y;for(var a=0;a<n.points.length;a++){if(a==0)e.moveTo(t+n.points[a].x,i+n.points[a].y);else e.lineTo(t+n.points[a].x,i+n.points[a].y)}a=0;e.lineTo(t+n.points[a].x,i+n.points[a].y);e.closePath();e.stroke()}},removeTime:function(){if(I._time!=undefined){window.cancelAnimationFrame(I._time);I._time=undefined}},removeRepickFun:function(e){for(var n=0;n<I.repickFun.length;n++){if(e==I.repickFun[n]){I.repickFun.splice(n,1)}}},events:function(e,n){var t=I.canvas.width/I.canvas.getBoundingClientRect().width;var i={l:I.canvas.getBoundingClientRect().left+window.scrollX,t:I.canvas.getBoundingClientRect().top+window.scrollY};var a=(e.changedTouches[0].pageX-i.l)*t;var r=(e.changedTouches[0].pageY-i.t)*t;if(n!=undefined){n({x:a,y:r})}for(var f=0;f<p.length;f++){if(p[f].type==e.type){p[f].mc._event={x:a,y:r,fun:p[f].fun,mc:p[f].mc}}}function s(e,n,t,i){if(t==undefined||t==1){n.l+=e.offsetLeft;n.t+=e.offsetTop}if(e.parentElement!=null&&(t==undefined||t==2)){s(e.parentElement,n)}}},tweenCreate:function(e,n,t,i,a,r,f){var s={};s.name=e;s.mc=n;s.obj=t;s.time=i;s.sm={};s.callBack=f;for(var o in t){var c=n[o];var d=t[o];var l=[];if(d.length!=undefined&&d.length!=0){var u=[];var h=[];var v=[];var p=0;for(var m=0;m<d.length;m++){if(m==0){u.push(d[m]-c);v.push(c)}else{u.push(d[m]-d[m-1]);v.push(d[m-1])}p+=Math.abs(u[m])}for(var m=0;m<u.length;m++){if(p==0){h.push(parseInt(i*T/(1e3*u.length)))}else{h.push(parseInt(Math.abs(u[m])*i*T/(1e3*p)))}for(var g=0;g<h[m];g++){if(p==0){l.push(c);continue}var y=(g+1)/h[m];if(a!=undefined&&a!=-1){x=a(y)*(d[m]-v[m])+v[m]}else{var x=y*(d[m]-v[m])+v[m]}l.push(x)}}}else{var w=parseInt(i*T/1e3);for(var g=0;g<w;g++){var y=(g+1)/w;if(a!=undefined&&a!=-1){x=a(y)*(d-c)+c}else{var x=y*(d-c)+c}l.push(x)}}s.sm[o]=l;s.sm.i=0}if(r==undefined||r==false)s.loop=false;else{if(r>1)s.loop=-r;else s.loop=r}b.push(s);return s.name},tweenRemove:function(e){for(var n=0;n<b.length;n++){if(b[n].name==e){b.splice(n,1);break}}},removeMc:function(){b=[];p=[];I.stage._childs=[];I.clearEnd=true;this.removeTime()}};I.getLineTxt=function(e,n,t,i){if(e==undefined||e=="")return"";e=e.toString();var a=e.split("\n");var r="";for(var f=0;f<a.length;f++){var s=a[f];s=c(s,n,t,i);if(f!=0)r+="\n"+s;else r+=s}return r};a()}})(wmGame);